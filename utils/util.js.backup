// utils/util.js

// 调试模式
const DEBUG = false; // 发布时设为false

function debugLog(tag, data) {
  if (DEBUG) {
    console.log(`[UTIL DEBUG] ${tag}:`, data);
  }
}

// 获取所有行程记录
function getTrips() {
  try {
    const trips = wx.getStorageSync('trips') || [];
    debugLog('获取行程', { count: trips.length });
    
    // 验证数据格式
    const validTrips = trips.filter(trip => {
      return trip && trip.id && trip.time && trip.location;
    });
    
    if (validTrips.length !== trips.length) {
      console.warn('发现无效的行程数据，已过滤');
      wx.setStorageSync('trips', validTrips);
    }
    
    return validTrips.sort((a, b) => {
      const timeA = new Date(a.createTime || 0);
      const timeB = new Date(b.createTime || 0);
      return timeB - timeA;
    });
  } catch (e) {
    console.error('获取行程失败', e);
    // 移除内部提示，让调用方处理
    return [];
  }
}

// 保存行程记录
function saveTrip(trip) {
  try {
    // 验证数据
    if (!trip || !trip.time || !trip.location || !trip.user) {
      console.error('保存行程失败：数据不完整', trip);
      return { success: false, message: '请填写完整信息' };
    }

    const trips = getTrips();
    const newTrip = {
      id: Date.now().toString(),
      user: trip.user,
      time: trip.time,
      location: trip.location.trim(),
      content: (trip.content || '').trim(),
      createTime: new Date().toISOString()
    };
    
    trips.push(newTrip);
    wx.setStorageSync('trips', trips);
    debugLog('保存行程成功', { id: newTrip.id, location: newTrip.location });
    return { success: true, message: '行程记录成功' };
  } catch (e) {
    console.error('保存行程失败', e);
    return { success: false, message: '保存失败，请重试' };
  }
}

// 删除行程记录
function deleteTrip(tripId) {
  try {
    const trips = getTrips();
    const filteredTrips = trips.filter(trip => trip.id !== tripId);
    wx.setStorageSync('trips', filteredTrips);
    return true;
  } catch (e) {
    console.error('删除行程失败', e);
    return false;
  }
}

// 格式化时间
function formatTime(dateStr) {
  try {
    if (!dateStr) {
      return '未知时间';
    }
    
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) {
      console.warn('无效的日期格式:', dateStr);
      return '未知时间';
    }
    
    const now = new Date();
    const diff = now - date;
    
    // 小于1分钟
    if (diff < 60000) {
      return '刚刚';
    }
    // 小于1小时
    if (diff < 3600000) {
      return Math.floor(diff / 60000) + '分钟前';
    }
    // 今天
    if (date.toDateString() === now.toDateString()) {
      return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }
    // 昨天
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === yesterday.toDateString()) {
      return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }
    // 更早的日期
    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' + 
           date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
  } catch (e) {
    console.error('格式化时间失败', e);
    return '未知时间';
  }
}

// 格式化日期时间
function formatDateTime(dateStr) {
  try {
    if (!dateStr) {
      return '未知时间';
    }
    
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) {
      console.warn('无效的日期格式:', dateStr);
      return '未知时间';
    }
    
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (e) {
    console.error('格式化日期时间失败', e);
    return '未知时间';
  }
}

module.exports = {
  getTrips,
  saveTrip,
  deleteTrip,
  formatTime,
  formatDateTime
  // 不再需要导出 showUserToast
}